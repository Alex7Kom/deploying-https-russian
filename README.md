# Как правильно развернуть HTTPS

Перевод на русский язык статьи [Криса Палмера](http://noncombatant.org/) и [Яна Жу](https://www.eff.org/about/staff/yan-zhu) с сайта [EFF](https://www.eff.org/).

_Статья впервые опубликована 15 ноября 2010 года. Последнее обновление: 9 февраля 2017 года._

Распространяется по лицензии [Creative Commons Attribution License](https://creativecommons.org/licenses/by/3.0/us/deed.ru).

![Creative Commons Attribution License](https://i.creativecommons.org/l/by/3.0/us/88x31.png)

Оригинальная статья: [How to Deploy HTTPS Correctly](https://www.eff.org/https-everywhere/deploying-https)

Интернет-технологам всегда было известно, что HTTP небезопасен и приводит к множеству рисков для пользователей. HTTP-трафик не зашифрован, поэтому любые данные, передаваемые по HTTP могут прочитаны и изменены кем угодно, у кого есть доступ к сети. Как стало известно из документов Сноудена об электронном шпионаже АНБ, HTTP-трафик также может собираться и изучаться правительственными агенствами без уведомления пользователей или веб-мастеров. Имея в виду данные риски, EFF считает, что [каждый сайт должен включить HTTPS](https://www.eff.org/encrypt-the-web) на всех страницах как можно быстрее.

Несмотря на то, что HTTPS существует уже достаточно давно как абсолютный минимум для веб-безопасности, многие сайты не спешили с его применением. Частично это связано с тем, что обеспечение правильной и полной работы приложения через HTTPS требует некоторых усилий.

Эта статья была создана с целью сподвигнуть и помочь веб-мастерам во включении и улучшении поддержки HTTPS. Хотя не существует универсальной защиты от всех угроз, поддержка HTTPS оградит пользователей от широкого спектра распространенных атак.

<!--more-->
## Основные сведения

HTTPS дает три гарантии безопасности:

* __Аутентификация сервера__ дает пользователям некоторую уверенность, что они общаются с настоящим сервером приложения. Без этой гарантии нельзя гарантировать конфиденциальность и целостность.

* __Конфиденциальность данных__ означает, что перехватчик сообщений не может понять содержимое сообщений между браузером пользователя и веб-сервером, потому что данные зашифрованы.

* __Целостность данных__ означает, что атакующий не может повредить или подменить содержимое сообщений между браузером пользователя и веб-сервером, потому что они проверяются криптографическими [кодами аутентичности сообщений](https://ru.wikipedia.org/wiki/Имитовставка).

__HTTP не предоставляет никаких гарантий безопасности__, и приложения, использующие его, __никак не могут предоставить пользователям какую-либо безопасность__. При использовании веб-приложения по HTTP, у людей нет способа понять, действительно ли они общаются с реальным сервером приложения, как и не могут они быть уверены, что атакующие не читают или подменяют сообщения между компьютером пользователя и сервером.

## Способы атаки и защиты

Однако пользователи выходят в интернет, и существует множество людей, кто может атаковать их — подглядывая за ними, выдавая себя за них, манипулируя с их сообщениями, или все вместе. администратор сети Wi-Fi может делать это; любой интернет-провайдер по пути от клиента до сервера может делать это; любой, кто может перенастроить Wi-Fi или другой маршрутизатор может делать это; и часто, любой, кто пользуется той же сетью может тоже это делать.

[Firesheep](http://codebutler.com/firesheep-a-day-later/) – пример _пассивной сетевой атаки_: оно подслушивает трафик сетевого обмена между браузером и сервером, но не перенаправляет или модифицирует его. Правительственные программы электронного шпионажа вроде [XKeyscore](http://www.theguardian.com/world/2013/jul/31/nsa-top-secret-program-online-data), также осуществляют пассивную атаку на HTTP-трафик, собирая огромные массивы данных онлайн-коммуникации.

Но в свободном доступе есть и другие утилиты для выполнения _активных сетевых атак_, где атакующий может модифицировать содержимое сообщений и/или перенаправлять их. Эти утилиты разнятся от серьезных, вроде [sslstrip](http://www.thoughtcrime.org/software/sslstrip/), до шуточных, вроде [Upside-Down-Ternet](http://www.ex-parrot.com/pete/upside-down-ternet.html). Хотя Upside-Down-Ternet и веселый розыгрыш, технически он равен потенциально более опасным атакам, таким как инъекция вредоносного кода или неправильной информации в веб-страницы; в то же время он демонстрирует, что такие атаки достаточно просты, чтобы быть шутками. Многие бесплатные Wi-Fi-точки известны тем, что динамически включают рекламу в страницы, просматриваемые пользователем, означая, что активные сетевые атаки являются жизнеспособной бизнес-моделью. Утилиты вроде [Cain and Abel](http://www.oxid.it/cain.html) дают возможности для осуществления широкого спектра атак, включая перенаправление локального сетевого трафика через систему злоумышленника. (См. также [Arpspoof](http://arpspoof.sourceforge.net/) и [dsniff](http://www.monkey.org/~dugsong/dsniff/)).

Только механизм, предоставляющий (по крайней мере) аутентификацию, конфиденциальность и целостность, может защитить от целого ряда атак. На данный момент HTTPS — лучшее, из того, что доступно для веб-приложений.

Однако, существует несколько потенциальных подводных камней, которые веб-мастера должны избежать, чтобы безопасно развернуть HTTPS.

## Смешанное содержимое

При работе веб-приложения через HTTPS не должно быть смешанного содержимого; да, все содержимое на странице должно загружаться через HTTPS. Часто можно увидеть частичную поддержку HTTPS на сайтах, где основные страницы загружаются по HTTPS, но некоторые или все медиа-элементы, таблицы стилей и JavaScript на странице загружаются по HTTP.

Это небезопасно, поскольку, хотя и загрузка страниц защищена от активных и пассивных атак, не защищен ни один из этих ресурсов. Если страница загружает некоторый код JavaScript или CSS по HTTP, атакующий может подменить этот код вредоносным и получить контроль над DOM страницы после ее загрузки. При этом пользователь возвращается к ситуации отсутствия безопасности. Это основная причина, по которой все основные браузеры предупреждают пользователей о страницах, которые загружают смешанное содержимое. Небезопасно и ссылаться на изображения по HTTP: что если в приложении веб-почты атакующий поменял местами иконки «Сохранить сообщение» и «Удалить сообщение»?

__Веб-приложение полностью должно работать по HTTPS.__ Перенаправляйте HTTP-запросы кодами 301 или 302 на эквивалентный ресурс, доступный по HTTPS.

Некоторые сайты предоставляют только страницы входа по HTTPS, аргументируя это тем, что пароль пользователя это единственная чувствительная информация. Пользователи таких сайтов _находятся под угрозой пассивных и активных атак_.

К сожалению, множество сайтов сегодня загружает содержимое с внешних сайтов и CDN, не поддерживающих HTTPS. Если невозможно загружать данные ресурсы со своего собственного домена, вы должны поторопить эти сайты, чтобы они немедленно начали поддерживать HTTPS.

## Безопасность и куки

Как было описано Крисом Палмером в [работе о безопасном управлении сессиями для веб-приложений](https://www.isecpartners.com/files/web-session-management.pdf), веб-мастера обязаны ограничивать область кук (особенно используемых для аутентификации) безопасным источником. Если область куки слишком широкая (с атрибутом `Domain` в заголовке `Set-Cookie:`), она может «протекать» на другие хосты или приложения в том же домене, потенциально менее защищенные хосты или приложения.

Также, приложение должно указывать атрибут `Secure` при установке куки. Данный атрибут указывает браузеру, что посылать куку можно только через защищенное (HTTPS) соединение, никогда через незащищенное (HTTP).

## Используйте HTTP Strict Transport Security

[HTTP Strict Transport Security](https://en.wikipedia.org/wiki/Strict_Transport_Security) (HSTS) — расширение протокола HTTP, которое позволяет сайту сообщать браузерам, что сайт использует HTTPS. Оно поддерживается [всеми основными браузерами](https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security#Browser_support).

Важно: Если вы включаете HSTS, а затем ломаете конфигурацию HTTPS на своем сайте, браузеры не дадут пользователям проигнорировать и пропустить предупреждения об ошибках. Поэтому, мы рекомендуем начинать с короткого `max-age` в заголовке HSTS, плавно увеличивая его в течение нескольких недель, в итоге доводя до `max-age=32000000`.

После того как вы успешно развернули HSTS-заголовок и уверены в нем, вы можете добавить предзагрузку HSTS как дополнительную меру безопасности.
Чтобы добавить свой сайт в предзагрузку HSTS, убедитесь что он соответствует всем условиям, перечисленным на [hstspreload.org](https://hstspreload.org), и оставьте там заявку. После того как его примут, ваш сайт со временем будет зашит в список, который поставляется вместе с браузерами, поддерживающими HSTS, чтобы отдельная копия одного из этих браузеров знала об HSTS на вашем сайте до его посещения. Это предотвращает атаки, которые могут бы осуществлены до первого посещения сайта.

## Выбирайте стойкие протоколы и алгоритмы

Краткий список рекомендаций по выбору протоколов и алгоритмов шифрования при развертывании SSL:

* Выключите поддержку SSLv2, SSLv3 и TLS 1.0.

* Поддерживайте TLS 1.1 и 1.2.

* Не используйте наборы алгоритмов NULL, aNULL и eNULL, так как они не позволяют одновременно шифрование и аутентификацию.

* Используйте стойкие приватные ключи, по крайней мере, как 2048-битный RSA-ключ.

* Отдайте предпочтение наборам алгоритмов, включающих __обмен временными ключами Диффи—Хеллмана__. Это позволяет получить важное свойство [Perfect Forward Secrecy](https://www.eff.org/deeplinks/2013/08/pushing-perfect-forward-secrecy-important-web-privacy-protection), которое предотвращает расшифровку старого веб-трафика, если ваш приватный SSL-ключ будет скомпрометирован в будущем.

* Не используйте наборы алгоритмов с ключами для шифрования короче 128 бит.

* Не используйте наборы алгоритмов, которые используют MD5 для хеширования. SHA-1 также не рекомендуется, но может быть необходим для совместимости с TLS 1.0 и SSLv3.

* Не используйте наборы алгоритмов, использующие RC4 для шифрования. AES-CBC предпочтительнее RC4, но уязвим для атаки [BEAST](https://www.imperialviolet.org/2011/09/23/chromeandbeast.html). Таким образом, чаще рекомендуется AES-GCM.

* Отключите сжатие TLS, чтобы предовтратить атаку [CRIME](https://en.wikipedia.org/wiki/CRIME_%28security_exploit%29).

* Поддерживайте только безопасные переустановки (renegotiation) соединения TLS, в соответсвии с [RFC 5746](http://www.ietf.org/rfc/rfc5746.txt), или отключите их полностью.

[Qualys's SSL Server Test](https://www.ssllabs.com/ssltest/) — полезный инструмент для проверки хорошо известных слабых мест в существующей конфигурации HTTPS.

Также обратите внимание на [набор рекомендуемых конфигураций TLS](https://wiki.mozilla.org/Security/Server_Side_TLS#Recommended_configurations) и [генератор конфигураций](https://mozilla.github.io/server-side-tls/ssl-config-generator/) от Mozilla, которые помогут выбрать подходящую конфигурацию для ваших нужд.

## Вопросы о производительности

Многие веб-мастера утверждают, что не могут перейти на HTTPS из-за вопросов с производительностью. Однако, большинство из тех, кто говорит такое, на самом деле не замеряли потерь в производительности, и могли вообще не замерять производительность, не профилировали и не оптимизировали поведение их сайта. Обычно сайты имеют задержки куда более высокие и/или пропускную способность более низкую, чем необходимо, даже при хостинге HTTP, показывая, что HTTPS не является проблемой.

Корень проблемы с производительностью часто лежит на уровне контента и довольно часто на уровне базы данных. Веб-приложения по природе своей очень зависят от I/O, в конце концов. Примите во внимание следующие [разумные выводы команды разработчиков Gmail](http://gmailblog.blogspot.com/2008/05/need-for-speed-path-to-faster-loading.html):

> Сначала мы составили список всех транзакций между браузером и серверами Google, начиная с того момента, как нажата кнопка «Войти». Для этого мы использовали множество различных утилит для разработчиков, вроде [Httpwatch](http://httpwatch.com/), [WireShark](http://www.wireshark.org/) и [Fiddler](http://www.fiddlertool.com/fiddler/), а также наши собственные системы измерения производительности. [...]

> Мы провели часы в тщательном изучении этих следов, чтобы понять, что именно проиходит между браузером и Gmail во время входа, и мы обнаружили, что небходимо от 14 до 24 HTTP-запросов, чтобы загрузить и отобразить «Входящие». Для сравнения, новостному сайту популярной сети требовалось выполнить около 180 запросов, чтобы полностью загрузиться, когда я проверял вчера. Но когда мы изучили наши запросы, мы поняли, что можем улучшить это. Мы решили атаковать проблему с нескольких сторон сразу: уменьшить общее количество запросов, сделать больше запросов кешируемыми браузером, и уменьшить затраты на каждый запрос.

> Мы преуспели в каждом направлении. Мы уменьшили вес каждого запроса, избавившись или уменьшив область некоторых кук. Мы убедились, что все наши изображения кешируются браузером, и мы собрали маленькие изображения иконок к одно мета-изображение, которое называют спрайтом. Мы совместили несколько отдельных запросов в единственный запрос и ответ. В результате сейчас требуется выполнить всего 4 запроса от нажатия кнопки «Войти» до отображения вашего ящика.

Адам Лэнгли из Google [делится дополнительными подробностями](http://www.imperialviolet.org/2010/06/25/overclocking-ssl.html):

> Чтобы сделать это нам _не потребовалось дополнительных машин_ и _никакого специального оборудования_. На серверах нашего продакшн-фронтэнда, SSL/TLS отвечает менее чем за 1% нагрузки на CPU, менее чем за 10 КБ памяти на соединение и менее чем за 2% служебного сетевого трафика. Многие люди думают, что SSL требует много процессорного времени, и мы надеемся, что данные цифры (впервые опубликованные) помогут развеять данный миф.

Что удивительного в том, что Gmail прекрасно работает, при этом используя исключительно HTTPS? Веб-мастера могут добиться улучшений целенаправленно работая над своими веб-приложениями. Крис выступал с докладом об этом эффекте на [Web 2.0 Expo 2009](http://assets.en.oreilly.com/1/event/22/High%20Performance,%20Low%20Cost,%20and%20Strong%20Security_%20Pick%20Any%20Three%20Presentation.pdf).

## Заключение

HTTPS предоставляет необходимую основную безопасность для пользователей веб-приложений, и оставаться на HTTP нет никаких причин, ни в плане нагрузки, ни в плане затрат. Создатели веб-приложений [подрывают свою бизнес-модель](http://papers.ssrn.com/sol3/papers.cfm?abstract_id=1421553), продолжая использование HTTP, так как они позволяют множеству атакующих в интернете компрометировать информацию своих пользователей.
